import React, { useState, useEffect } from 'react';
import { motion, AnimatePresence } from 'framer-motion';
import { Upload, FileText, CheckCircle2, AlertCircle, ArrowRight, ShieldCheck, XCircle, Search, Scale, SlidersHorizontal, ChevronDown, ExternalLink, Edit3, Check, MousePointer2, Download } from 'lucide-react';
import EditableStructureTable from './EditableStructureTable';
import Tooltip from './Tooltip';
import { legalRequirements } from './legalRequirements';
import { getRandomTip } from './loadingTips';

// --- Sub-components ---

const StepIndicator = ({ currentStep }) => {
    const steps = [
        { id: 'upload', label: '1. 사진 업로드', icon: Upload },
        { id: 'structured', label: '2. 정보 매핑', icon: FileText },
        { id: 'result', label: '3. 결과 분석', icon: ShieldCheck },
        { id: 'contract', label: '4. 계약서 작성', icon: FileText },
    ];

    const currentIdx = steps.findIndex(s => s.id === currentStep);

    return (
        <div className="step-container">
            {steps.map((step, idx) => {
                const Icon = step.icon;
                const isActive = idx === currentIdx;
                const isCompleted = idx < currentIdx;

                return (
                    <div key={step.id} className={`step-item ${isActive ? 'active' : ''} ${isCompleted ? 'completed' : ''}`}>
                        <div className="step-icon-box">
                            {isCompleted ? <Check size={24} /> : <Icon size={24} />}
                        </div>
                        <span className="step-label">{step.label}</span>
                        <div className="step-line" />
                    </div>
                );
            })}
        </div>
    );
};

// --- Main App ---

const App = () => {
    const [selectedService, setSelectedService] = useState(null);
    const [files, setFiles] = useState([]); // Changed from single file to array
    const [isAnalyzing, setIsAnalyzing] = useState(false);
    const [progress, setProgress] = useState(0);
    const [result, setResult] = useState(null);
    const [companySize, setCompanySize] = useState("5more");
    const [workerType, setWorkerType] = useState("regular");
    const [currentStep, setCurrentStep] = useState('upload');
    const [extractedText, setExtractedText] = useState("");
    const [structuredData, setStructuredData] = useState(""); // 🆕 구조화된 데이터
    const [previewUrls, setPreviewUrls] = useState([]); // Changed to array
    const [isGenerating, setIsGenerating] = useState(false);
    const [generatedContract, setGeneratedContract] = useState(null);

    // Helpers to get char image by service
    const getCharImage = (svc) => {
