import React, { useState, useEffect } from 'react';
import { motion, AnimatePresence } from 'framer-motion';
import { Upload, FileText, CheckCircle2, AlertCircle, ArrowRight, ShieldCheck, XCircle, Search, Scale, SlidersHorizontal, ChevronDown, ExternalLink, Edit3, Check, MousePointer2, Download } from 'lucide-react';
import EditableStructureTable from './EditableStructureTable';
import Tooltip from './Tooltip';
import { legalRequirements } from './legalRequirements';
import { getRandomTip } from './loadingTips';

// --- Sub-components ---

const StepIndicator = ({ currentStep }) => {
    const steps = [
        { id: 'upload', label: '1. ì‚¬ì§„ ì—…ë¡œë“œ', icon: Upload },
        { id: 'structured', label: '2. ì •ë³´ ë§¤í•‘', icon: FileText },
        { id: 'result', label: '3. ê²°ê³¼ ë¶„ì„', icon: ShieldCheck },
        { id: 'contract', label: '4. ê³„ì•½ì„œ ì‘ì„±', icon: FileText },
    ];

    const currentIdx = steps.findIndex(s => s.id === currentStep);

    return (
        <div className="step-container">
            {steps.map((step, idx) => {
                const Icon = step.icon;
                const isActive = idx === currentIdx;
                const isCompleted = idx < currentIdx;

                return (
                    <div key={step.id} className={`step-item ${isActive ? 'active' : ''} ${isCompleted ? 'completed' : ''}`}>
                        <div className="step-icon-box">
                            {isCompleted ? <Check size={24} /> : <Icon size={24} />}
                        </div>
                        <span className="step-label">{step.label}</span>
                        <div className="step-line" />
                    </div>
                );
            })}
        </div>
    );
};

// --- Main App ---

const App = () => {
    const [selectedService, setSelectedService] = useState(null);
    const [files, setFiles] = useState([]); // Changed from single file to array
    const [isAnalyzing, setIsAnalyzing] = useState(false);
    const [progress, setProgress] = useState(0);
    const [result, setResult] = useState(null);
    const [companySize, setCompanySize] = useState("5more");
    const [workerType, setWorkerType] = useState("regular");
    const [currentStep, setCurrentStep] = useState('upload');
    const [extractedText, setExtractedText] = useState("");
    const [structuredData, setStructuredData] = useState(""); // ğŸ†• êµ¬ì¡°í™”ëœ ë°ì´í„°
    const [previewUrls, setPreviewUrls] = useState([]); // Changed to array
    const [isGenerating, setIsGenerating] = useState(false);
    const [generatedContract, setGeneratedContract] = useState(null);

    // Helpers to get char image by service
    const getCharImage = (svc) => {
        if (svc === 'contract') return '/contract_char.png';
        if (svc === 'rule') return '/rule_char.png';
        if (svc === 'salary') return '/salary_char.png';
        return null;
    };

    const handleFileChange = (e) => {
        if (e.target.files && e.target.files.length > 0) {
            const selectedFiles = Array.from(e.target.files);
            setFiles(selectedFiles);

            // Generate preview URLs for all files
            if (previewUrls.length > 0) {
                previewUrls.forEach(url => URL.revokeObjectURL(url));
            }
            const newPreviewUrls = selectedFiles.map(file => URL.createObjectURL(file));
            setPreviewUrls(newPreviewUrls);
        }
    };

    const extractOCR = async () => {
        if (files.length === 0) { alert('íŒŒì¼ì„ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”.'); return; }
        setIsAnalyzing(true); setProgress(0);

        let combinedText = "";
        const totalFiles = files.length;

        // Progress interval just for visual effect
        const interval = setInterval(() => { setProgress(prev => Math.min(prev + 5, 90)); }, 300);

        try {
            for (let i = 0; i < totalFiles; i++) {
                const fd = new FormData();
                fd.append('file', files[i]);

                // Update progress based on file processing
                const currentProgress = Math.round(((i) / totalFiles) * 90);
                setProgress(currentProgress);

                const res = await fetch('http://localhost:3001/api/ocr/extract', { method: 'POST', body: fd });
                if (!res.ok) throw new Error(`íŒŒì¼ ${i + 1} OCR ì‹¤íŒ¨`);

                const data = await res.json();
                if (data.extractedText) {
                    combinedText += `\n--- ë¬¸ì„œ ${i + 1} ---\n` + data.extractedText + "\n";
                }
            }

            clearInterval(interval); setProgress(100);
            setExtractedText(combinedText.trim());

            // ğŸ†• êµ¬ì¡°í™” ë‹¨ê³„ë¡œ ì´ë™
            await structureData(combinedText.trim());
        } catch (error) {
            clearInterval(interval);
            setIsAnalyzing(false);
            alert('OCR ì˜¤ë¥˜: ' + error.message);
        }
    };

    // ğŸ†• êµ¬ì¡°í™” í•¨ìˆ˜
    const structureData = async (text) => {
        try {
            const res = await fetch('http://localhost:3001/api/ocr/structure', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ extractedText: text })
            });
            if (!res.ok) throw new Error('êµ¬ì¡°í™” ì‹¤íŒ¨');
            const data = await res.json();
            setStructuredData(data.structuredData);
            setCurrentStep('structured');
            setIsAnalyzing(false);
        } catch (error) {
            console.error('êµ¬ì¡°í™” ì˜¤ë¥˜:', error);
            // êµ¬ì¡°í™” ì‹¤íŒ¨ ì‹œ ì›ë³¸ í…ìŠ¤íŠ¸ë¡œ review ë‹¨ê³„ë¡œ ì´ë™
            alert('êµ¬ì¡°í™” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì›ë³¸ í…ìŠ¤íŠ¸ë¡œ ì§„í–‰í•©ë‹ˆë‹¤.');
            setCurrentStep('review');
            setIsAnalyzing(false);
        }
    };

    const runFinalAnalysis = async () => {
        // êµ¬ì¡°í™”ëœ ë°ì´í„° ë˜ëŠ” ì›ë³¸ í…ìŠ¤íŠ¸ ì‚¬ìš©
        const dataToAnalyze = structuredData || extractedText;
        if (!dataToAnalyze || dataToAnalyze.trim().length < 10) {
            alert('ë‚´ìš©ì´ ë„ˆë¬´ ì§§ìŠµë‹ˆë‹¤. ìµœì†Œ 10ì ì´ìƒ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            return;
        }
        setIsAnalyzing(true); setProgress(0);
        const interval = setInterval(() => { setProgress(prev => Math.min(prev + 5, 90)); }, 400);
        try {
            const res = await fetch('http://localhost:3001/api/analyze/contract', {
                method: 'POST', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ workerType, companySize, manualText: dataToAnalyze, serviceType: selectedService })
            });
            if (!res.ok) { throw new Error('ë¶„ì„ ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜'); }
            const data = await res.json();
            clearInterval(interval); setProgress(100); setResult(data); setCurrentStep('result'); setIsAnalyzing(false);
        } catch (error) { clearInterval(interval); setIsAnalyzing(false); alert('ë¶„ì„ ì˜¤ë¥˜: ' + error.message); }
    };

    const handleAnalysisStart = (service) => {
        setSelectedService(service);
        setFiles([]);
        if (previewUrls.length > 0) {
            previewUrls.forEach(url => URL.revokeObjectURL(url));
        }
        setPreviewUrls([]);
        setResult(null);
        setProgress(0);
        setExtractedText("");
        setStructuredData(""); // êµ¬ì¡°í™” ë°ì´í„° ì´ˆê¸°í™”
        setCurrentStep('upload');
        setGeneratedContract(null);
    };

    const generateContract = async () => {
        setIsGenerating(true);
        try {
            const res = await fetch('http://localhost:3001/api/generate/contract', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    analysisResult: result,
                    originalText: extractedText,
                    workerType,
                    companySize
                })
            });
            if (!res.ok) throw new Error('ê³„ì•½ì„œ ìƒì„± ì˜¤ë¥˜');
            const data = await res.json();
            setGeneratedContract(data.contractText);
            setCurrentStep('contract');
        } catch (error) {
            alert('ê³„ì•½ì„œ ìƒì„± ì‹¤íŒ¨: ' + error.message);
        } finally {
            setIsGenerating(false);
        }
    };

    const renderLawBadges = (lawString) => {
        if (!lawString) return null;
        const laws = lawString.split(/[,;]+/).map(l => l.trim()).filter(l => l && l.length > 2);
        return (
            <div className="law-badge-container">
                {laws.map((law, idx) => (
                    <a key={idx} href={`https://www.law.go.kr/LSW/lsSc.do?menuId=1&query=${encodeURIComponent(law)}`} target="_blank" rel="noopener noreferrer" className="law-badge">
                        âš–ï¸ {law} <ExternalLink size={12} />
                    </a>
                ))}
            </div>
        );
    };

    return (
        <div className="min-h-screen bg-slate-50">
            <nav className="header-nav glass">
                <div style={{ display: 'flex', alignItems: 'center', gap: '0.5rem' }}>
                    <ShieldCheck className="text-primary" size={28} />
                    <span style={{ fontSize: '1.25rem', fontWeight: 800 }}>ë…¸ë™ë²• ììœ¨ì ê²€ AI</span>
                </div>
                <div className="nav-user"><Search size={20} color="var(--text-muted)" /><div style={{ width: 32, height: 32, borderRadius: '50%', background: '#e2e8f0', display: 'flex', alignItems: 'center', justifyContent: 'center' }}><span style={{ fontSize: '0.8rem', fontWeight: 600 }}>U</span></div></div>
            </nav>

            <main style={{ paddingBottom: '5rem' }}>
                <section className="hero-section">
                    <motion.div initial={{ opacity: 0, y: 20 }} animate={{ opacity: 1, y: 0 }} transition={{ duration: 0.6 }}>
                        <h1 className="hero-title">AIê°€ ì§€í‚¤ëŠ”<br />ë‹¹ì‹ ì˜ ë…¸ë™ ê¶Œë¦¬</h1>
                        <p className="text-muted" style={{ fontSize: '1.1rem' }}>ë³µì¡í•œ ê³„ì•½ì„œ, í´ë¦­ í•œ ë²ˆìœ¼ë¡œ ë²•ë¥  ë¦¬ìŠ¤í¬ë¥¼ ì§„ë‹¨í•˜ì„¸ìš”.</p>
                    </motion.div>
                </section>

                <div className="bento-grid">
                    <motion.div className="bento-item glass" whileHover={{ y: -8, scale: 1.02 }} onClick={() => handleAnalysisStart('contract')}>
                        <div className="bento-char-box">
                            <motion.img
                                layoutId="char-img-contract"
                                src="/contract_char.png"
                                alt="ê·¼ë¡œê³„ì•½ì„œ ìºë¦­í„°"
                                className="bento-char-img"
                            />
                        </div>
                        <div className="bento-content">
                            <div className="bento-header">
                                <div className="bento-icon-box"><FileText size={20} /></div>
                                <ArrowRight color="var(--text-muted)" size={18} />
                            </div>
                            <h3>ê·¼ë¡œê³„ì•½ì„œ</h3>
                            <p className="text-muted">ë²•ì  ìœ„ë°˜ ì¡°í•­ ê°ì§€</p>
                            <div className="status-badge status-appropriate">#2ë‹¨ê³„ê²€ì¦</div>
                        </div>
                    </motion.div>

                    <motion.div className="bento-item glass" whileHover={{ y: -8, scale: 1.02 }} onClick={() => handleAnalysisStart('rule')}>
                        <div className="bento-char-box">
                            <motion.img
                                layoutId="char-img-rule"
                                src="/rule_char.png"
                                alt="ì·¨ì—…ê·œì¹™ ìºë¦­í„°"
                                className="bento-char-img"
                            />
                        </div>
                        <div className="bento-content">
                            <div className="bento-header">
                                <div className="bento-icon-box"><Scale size={20} /></div>
                                <ArrowRight color="var(--text-muted)" size={18} />
                            </div>
                            <h3>ì·¨ì—…ê·œì¹™</h3>
                            <p className="text-muted">ë¶ˆë¦¬í•œ ì¡°í•­ ë¶„ì„</p>
                            <div className="status-badge status-warning">#í‘œì¤€ì•ˆë¹„êµ</div>
                        </div>
                    </motion.div>

                    <motion.div className="bento-item glass" whileHover={{ y: -8, scale: 1.02 }} onClick={() => handleAnalysisStart('salary')}>
                        <div className="bento-char-box">
                            <motion.img
                                layoutId="char-img-salary"
                                src="/salary_char.png"
                                alt="ì„ê¸ˆëª…ì„¸ì„œ ìºë¦­í„°"
                                className="bento-char-img"
                            />
                        </div>
                        <div className="bento-content">
                            <div className="bento-header">
                                <div className="bento-icon-box"><SlidersHorizontal size={20} /></div>
                                <ArrowRight color="var(--text-muted)" size={18} />
                            </div>
                            <h3>ì„ê¸ˆëª…ì„¸ì„œ</h3>
                            <p className="text-muted">ì˜¤ì§€ê¸‰ ìˆ˜ë‹¹ ìë™ ê³„ì‚°</p>
                            <div className="status-badge status-violation">#ìµœì €ì„ê¸ˆê²€ì¦</div>
                        </div>
                    </motion.div>
                </div>
            </main>

            <AnimatePresence>
                {selectedService && (
                    <motion.div className={currentStep === 'result' ? "analysis-overlay" : "upload-modal-overlay"} initial={{ opacity: 0 }} animate={{ opacity: 1 }} exit={{ opacity: 0 }}>
                        <StepIndicator currentStep={currentStep} />

                        {currentStep === 'upload' && (
                            <motion.div className="upload-card" initial={{ scale: 0.8, opacity: 0 }} animate={{ scale: 1, opacity: 1 }} transition={{ type: "spring", duration: 0.5 }}>
                                <div style={{ position: 'relative' }}>
                                    <button onClick={() => setSelectedService(null)} style={{ position: 'absolute', top: -10, right: -10, background: 'none', border: 'none', cursor: 'pointer', zIndex: 10 }}><XCircle color="var(--text-muted)" size={28} /></button>
                                </div>

                                <div style={{ display: 'flex', alignItems: 'center', gap: '1rem', marginBottom: '2rem' }}>
                                    <div style={{ width: 48, height: 48, borderRadius: '12px', overflow: 'hidden', background: '#f1f5f9', border: '1px solid #e2e8f0' }}>
                                        <img src={getCharImage(selectedService)} alt="" style={{ width: '100%', height: '100%', objectFit: 'cover' }} />
                                    </div>
                                    <div>
                                        <h2 style={{ fontSize: '1.25rem', fontWeight: 800, margin: 0, color: '#1e293b' }}>
                                            {selectedService === 'contract' ? 'ê·¼ë¡œê³„ì•½ì„œ ë¶„ì„' : selectedService === 'rule' ? 'ì·¨ì—…ê·œì¹™ ì •ë°€ ì ê²€' : 'ì„ê¸ˆëª…ì„¸ì„œ ìë™ ê²€ì¦'}
                                        </h2>
                                        <p style={{ margin: 0, color: '#64748b', fontSize: '0.9rem' }}>AIê°€ ì„œë¥˜ë¥¼ ë¶„ì„í•˜ì—¬ ë²•ì  ë¦¬ìŠ¤í¬ë¥¼ ì§„ë‹¨í•´ë“œë¦½ë‹ˆë‹¤.</p>
                                    </div>
                                </div>

                                {!isAnalyzing ? (
                                    <>
                                        <div style={{ background: '#f0f9ff', padding: '2rem', borderRadius: '16px', marginBottom: '2rem', textAlign: 'center' }}>
                                            <div style={{ display: 'flex', flexDirection: 'column', alignItems: 'center', justifyContent: 'center', gap: '1rem', fontSize: '1.1rem', fontWeight: 700 }}>
                                                <div style={{ display: 'flex', flexWrap: 'wrap', alignItems: 'center', justifyContent: 'center', gap: '0.8rem' }}>
                                                    <span>ìš°ë¦¬ ì‚¬ì—…ì¥ì€</span>
                                                    <div className="select-wrapper">
                                                        <select value={companySize} onChange={(e) => setCompanySize(e.target.value)} className="select-custom">
                                                            <option value="under5">ìƒì‹œ 5ì¸ ë¯¸ë§Œ</option><option value="5more">ìƒì‹œ 5ì¸ ì´ìƒ</option>
                                                        </select>
                                                        <ChevronDown size={20} className="select-icon" />
                                                    </div>
                                                    <span>ê·œëª¨ì´ë©°,</span>
                                                </div>
                                                <div style={{ display: 'flex', flexWrap: 'wrap', alignItems: 'center', justifyContent: 'center', gap: '0.8rem' }}>
                                                    <span>ì €ëŠ”</span>
                                                    <div className="select-wrapper">
                                                        <select value={workerType} onChange={(e) => setWorkerType(e.target.value)} className="select-custom">
                                                            <option value="regular">ì¼ë°˜(ì •ê·œì§)</option><option value="fixed-term">ê¸°ê°„ì œ</option><option value="part-time">ì•Œë°”(ë‹¨ì‹œê°„)</option>
                                                        </select>
                                                        <ChevronDown size={20} className="select-icon" />
                                                    </div>
                                                    <span>ê·¼ë¡œìì…ë‹ˆë‹¤.</span>
                                                </div>
                                            </div>
                                        </div>
                                        <div className="dropzone">
                                            <input type="file" id="fileInput" hidden accept="image/*" multiple onChange={handleFileChange} />
                                            <label htmlFor="fileInput" style={{ cursor: 'pointer', display: 'block' }}>
                                                <Upload size={40} style={{ margin: '0 auto 1rem', color: 'var(--primary)' }} />
                                                <h3 style={{ marginBottom: '0.5rem' }}>{files.length > 0 ? `${files.length}ê°œì˜ íŒŒì¼ ì„ íƒë¨` : 'ê³„ì•½ì„œ ì‚¬ì§„ ì—…ë¡œë“œ'}</h3>
                                                <p className="text-muted">{files.length > 0 ? files.map(f => f.name).join(', ') : 'í´ë¦­í•˜ì—¬ íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš” (ì—¬ëŸ¬ ì¥ ê°€ëŠ¥)'}</p>
                                            </label>
                                        </div>
                                        <button className="analyze-button" onClick={extractOCR} disabled={files.length === 0}>ë‹¤ìŒ: ì •ë³´ í™•ì¸í•˜ê¸°</button>
                                    </>
                                ) : (
                                    <div style={{ padding: '4rem 0' }}>
                                        <motion.div animate={{ rotate: 360 }} transition={{ repeat: Infinity, duration: 2, ease: "linear" }} style={{ margin: '0 auto 2rem', width: 64 }}><ShieldCheck size={64} color="var(--primary)" /></motion.div>
                                        <h3>í…ìŠ¤íŠ¸ ì¶”ì¶œ ì¤‘... ({progress}%)</h3>
                                    </div>
                                )}
                            </motion.div>
                        )}

                        {
                            currentStep === 'structured' && (
                                <div className="split-container" style={{ maxWidth: '100%', width: '100%' }}>
                                    <div className="document-viewer" style={{ flex: 1 }}>
                                        <div style={{ position: 'sticky', top: '2rem', width: '100%' }}>
                                            <h4 style={{ fontWeight: 800, color: '#64748b', marginBottom: '1rem' }}>ì—…ë¡œë“œí•œ ì‚¬ì§„ ({previewUrls.length}ì¥)</h4>
                                            {previewUrls.length > 0 ? (
                                                <div style={{ display: 'flex', flexDirection: 'column', gap: '1rem' }}>
                                                    {previewUrls.map((url, idx) => (
                                                        <img key={idx} src={url} alt={`Uploaded Contract ${idx + 1}`} className="document-image" style={{ width: '100%', borderRadius: '16px', border: '2px solid #e2e8f0' }} />
                                                    ))}
                                                </div>
                                            ) : (
                                                <div style={{ padding: '3rem', background: '#f1f5f9', borderRadius: '16px', textAlign: 'center', color: '#94a3b8' }}>
                                                    <FileText size={48} style={{ margin: '0 auto 1rem' }} />
                                                    <p>ì´ë¯¸ì§€ê°€ ì—…ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤</p>
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                    <div className="analysis-panel" style={{ flex: 1 }}>
                                        <h2 style={{ marginBottom: '1rem', display: 'flex', alignItems: 'center', gap: '0.5rem' }}><FileText size={28} color="var(--primary)" /> AI êµ¬ì¡°í™” ë§¤í•‘ ê²°ê³¼</h2>
                                        <p style={{ marginBottom: '1.5rem', color: 'var(--text-muted)' }}>AIê°€ OCR í…ìŠ¤íŠ¸ë¥¼ ë¶„ì„í•˜ì—¬ í•­ëª©ë³„ë¡œ ì •ë¦¬í–ˆìŠµë‹ˆë‹¤. ì™¼ìª½ ì‚¬ì§„ì„ ë³´ë©° ì˜ëª»ëœ ë¶€ë¶„ì„ ìˆ˜ì •í•´ì£¼ì„¸ìš”.</p>
                                        <EditableStructureTable structuredData={structuredData} setStructuredData={setStructuredData} />
                                        <div style={{ display: 'flex', gap: '1rem' }}>
                                            <button onClick={() => setCurrentStep('upload')} style={{ flex: 1, padding: '1rem', borderRadius: '12px', border: '1px solid #cbd5e1', background: 'white', fontWeight: 700, cursor: 'pointer' }}>ì´ì „</button>
                                            <button onClick={runFinalAnalysis} disabled={isAnalyzing} style={{ flex: 2, padding: '1rem', borderRadius: '12px', background: isAnalyzing ? '#94a3b8' : 'var(--primary)', color: 'white', border: 'none', fontWeight: 700, fontSize: '1.1rem', cursor: isAnalyzing ? 'not-allowed' : 'pointer' }}>
                                                {isAnalyzing ? 'ë¶„ì„ ì¤‘...' : 'ìµœì¢… ë¶„ì„ ì‹œì‘'}
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            )
                        }

                        {
                            currentStep === 'review' && (
                                <div className="split-container" style={{ maxWidth: '100%', width: '100%' }}>
                                    <div className="document-viewer" style={{ flex: 1 }}>
                                        <div style={{ position: 'sticky', top: '2rem', width: '100%' }}>
                                            <h4 style={{ fontWeight: 800, color: '#64748b', marginBottom: '1rem' }}>ì—…ë¡œë“œí•œ ì‚¬ì§„ ({previewUrls.length}ì¥)</h4>
                                            {previewUrls.length > 0 ? (
                                                <div style={{ display: 'flex', flexDirection: 'column', gap: '1rem' }}>
                                                    {previewUrls.map((url, idx) => (
                                                        <img key={idx} src={url} alt={`Uploaded Contract ${idx + 1}`} className="document-image" style={{ width: '100%', borderRadius: '16px', border: '2px solid #e2e8f0' }} />
                                                    ))}
                                                </div>
                                            ) : (
                                                <div style={{ padding: '3rem', background: '#f1f5f9', borderRadius: '16px', textAlign: 'center', color: '#94a3b8' }}>
                                                    <FileText size={48} style={{ margin: '0 auto 1rem' }} />
                                                    <p>ì´ë¯¸ì§€ê°€ ì—…ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤</p>
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                    <div className="analysis-panel" style={{ flex: 1 }}>
                                        <h2 style={{ marginBottom: '1rem', display: 'flex', alignItems: 'center', gap: '0.5rem' }}><Edit3 size={28} color="var(--primary)" /> ì¶”ì¶œ ë‚´ìš© í™•ì¸ ë° ìˆ˜ì •</h2>
                                        <p style={{ marginBottom: '1.5rem', color: 'var(--text-muted)' }}>AIê°€ ì½ì€ ë‚´ìš©ì…ë‹ˆë‹¤. ì™¼ìª½ ì‚¬ì§„ì„ ë³´ë©° ì˜ëª»ëœ ë¶€ë¶„ì„ ì§ì ‘ ìˆ˜ì •í•´ì£¼ì„¸ìš”.</p>
                                        <div style={{ background: '#f8fafc', padding: '1.5rem', borderRadius: '16px', border: '2px solid #e2e8f0', marginBottom: '2rem' }}>
                                            <textarea
                                                value={extractedText}
                                                onChange={(e) => setExtractedText(e.target.value)}
                                                style={{ width: '100%', height: '400px', padding: '1rem', borderRadius: '12px', border: '1px solid #cbd5e1', fontSize: '1rem', lineHeight: '1.6', outline: 'none', fontFamily: 'inherit' }}
                                                placeholder="ì—¬ê¸°ì— ê³„ì•½ì„œ ë‚´ìš©ì„ ì‘ì„±í•˜ê±°ë‚˜ ìˆ˜ì •í•˜ì„¸ìš”..."
                                            />
                                            <p style={{ marginTop: '0.8rem', fontSize: '0.85rem', color: '#64748b' }}>ğŸ’¡ ì™¼ìª½ ì‚¬ì§„ê³¼ ë¹„êµí•˜ë©° ì˜ëª» ì½íŒ ìˆ«ì, ë‚ ì§œ ë“±ì„ ì§ì ‘ ê³ ì¹˜ë©´ ë¶„ì„ì´ ë” ì •í™•í•´ì§‘ë‹ˆë‹¤.</p>
                                        </div>
                                        <div style={{ display: 'flex', gap: '1rem' }}>
                                            <button onClick={() => setCurrentStep('upload')} style={{ flex: 1, padding: '1rem', borderRadius: '12px', border: '1px solid #cbd5e1', background: 'white', fontWeight: 700, cursor: 'pointer' }}>ì´ì „</button>
                                            <button onClick={runFinalAnalysis} disabled={isAnalyzing} style={{ flex: 2, padding: '1rem', borderRadius: '12px', background: isAnalyzing ? '#94a3b8' : 'var(--primary)', color: 'white', border: 'none', fontWeight: 700, fontSize: '1.1rem', cursor: isAnalyzing ? 'not-allowed' : 'pointer' }}>
                                                {isAnalyzing ? 'ë¶„ì„ ì¤‘...' : 'ìµœì¢… ë¶„ì„ ì‹œì‘'}
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            )
                        }

                        {
                            currentStep === 'result' && result && (
                                <div className="split-container">
                                    <div className="document-viewer">
                                        <div style={{ position: 'sticky', top: '2rem', width: '100%' }}>
                                            <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '1rem' }}>
                                                <h4 style={{ fontWeight: 800, color: '#64748b' }}>ì œì¶œëœ ë°ì´í„° ({previewUrls.length}ì¥)</h4>
                                                <button onClick={() => { setResult(null); setSelectedService(null); }} style={{ background: 'none', border: 'none', cursor: 'pointer' }}><XCircle size={24} color="#94a3b8" /></button>
                                            </div>
                                            {previewUrls.length > 0 ? (
                                                <div style={{ display: 'flex', flexDirection: 'column', gap: '1rem' }}>
                                                    {previewUrls.map((url, idx) => (
                                                        <img key={idx} src={url} alt="Original" className="document-image" style={{ width: '100%', borderRadius: '16px', border: '2px solid #e2e8f0' }} />
                                                    ))}
                                                </div>
                                            ) : (
                                                <div style={{ whiteSpace: 'pre-wrap', padding: '1.5rem', background: 'white', borderRadius: '12px', border: '1px solid #cbd5e1', fontSize: '0.9rem' }}>{extractedText}</div>
                                            )}
                                        </div>
                                    </div>
                                    <div className="analysis-panel">
                                        {isAnalyzing && (
                                            <motion.div className="loading-overlay" initial={{ opacity: 0 }} animate={{ opacity: 1 }}>
                                                <div className="loading-content">
                                                    <motion.div animate={{ rotate: 360 }} transition={{ repeat: Infinity, duration: 2, ease: "linear" }} style={{ marginBottom: '1.5rem' }}>
                                                        <ShieldCheck size={64} color="white" />
                                                    </motion.div>
                                                    <h3 style={{ color: 'white', fontSize: '1.5rem', marginBottom: '1rem' }}>ì „ë¬¸ AIê°€ ë²•ë ¹ì„ ê²€í†  ì¤‘ì…ë‹ˆë‹¤</h3>
                                                    <p style={{ color: 'rgba(255,255,255,0.8)', marginBottom: '2rem' }}>ì‚¬ìš©ìë‹˜ì˜ ì†Œì¤‘í•œ ê¶Œë¦¬ë¥¼ ìœ„í•´ 63ê°œ ë…¸ë™ ê´€ë ¨ ë²•ë ¹ê³¼<br />ìµœì‹  íŒë¡€ë¥¼ ê¼¼ê¼¼í•˜ê²Œ ëŒ€ì¡°í•˜ê³  ìˆìŠµë‹ˆë‹¤. ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.</p>
                                                    <div className="progress-bar-container">
                                                        <motion.div className="progress-bar-fill" initial={{ width: 0 }} animate={{ width: `${progress}%` }} />
                                                    </div>
                                                    <p style={{ color: 'white', marginTop: '1rem' }}>ì§„í–‰ë¥ : {progress}%</p>
                                                </div>
                                            </motion.div>
                                        )}
                                        <div className={`risk-summary-card ${result.riskLevel === 'ìƒ' || result.overallStatus === 'ìœ„í—˜' || result.overallStatus === 'ë¶€ì ì ˆ' || result.overallStatus === 'ë¶€ì ì •' ? 'risk-high' : result.riskLevel === 'ì¤‘' || result.overallStatus === 'ë³´ì™„í•„ìš”' || result.overallStatus === 'ì£¼ì˜' ? 'risk-medium' : 'risk-low'}`}>
                                            <div style={{ display: 'flex', gap: '1.5rem', alignItems: 'center' }}>
                                                {result.overallStatus === 'ìœ„í—˜' || result.overallStatus === 'ë¶€ì ì ˆ' ? <AlertCircle size={48} /> : <ShieldCheck size={48} />}
                                                <div>
                                                    <h2 style={{ fontSize: '2rem', fontWeight: 800, marginBottom: '0.5rem' }}>{result.overallStatus}</h2>
                                                    <p style={{ fontSize: '1.1rem', fontWeight: 600, opacity: 0.9 }}>{result.overallOpinion}</p>
                                                </div>
                                            </div>
                                        </div>

                                        <div className="analysis-table-container">
                                            <table className="analysis-table">
                                                <thead>
                                                    <tr>
                                                        <th style={{ width: '15%' }}>í•­ëª©</th>
                                                        <th style={{ width: '12%', textAlign: 'center' }}>íŒì •</th>
                                                        <th>ì§„ë‹¨ ë‚´ìš© ë° ëŒ€ì±…</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {result.results?.map((item, idx) => (
                                                        <tr key={idx}>
                                                            <td style={{ fontWeight: 800 }}>
                                                                {legalRequirements[item.í•­ëª©] ? (
                                                                    <Tooltip
                                                                        content={legalRequirements[item.í•­ëª©].requirement}
                                                                        category={legalRequirements[item.í•­ëª©].category}
                                                                    >
                                                                        {item.í•­ëª©}
                                                                    </Tooltip>
                                                                ) : item.í•­ëª©}
                                                                <br /><span style={{ fontSize: '0.7rem', color: '#94a3b8' }}>[{item.ì ìš©ì¡°ê±´}]</span>
                                                            </td>
                                                            <td style={{ textAlign: 'center' }}><span className={`status-badge ${item.ì ì ˆì„± === 'ì ì ˆ' ? 'status-appropriate' : item.ì ì ˆì„± === 'ë¶€ì ì ˆ' ? 'status-violation' : 'status-warning'}`}>{item.ì ì ˆì„±}</span></td>
                                                            <td>
                                                                <div style={{ fontWeight: 700, color: item.ì ì ˆì„± === 'ë¶€ì ì ˆ' ? '#b91c1c' : '#1e293b', marginBottom: '0.5rem' }}>{item.íŒë‹¨ì´ìœ }</div>
                                                                <div style={{ color: '#64748b', fontSize: '0.9rem', marginBottom: '0.8rem' }}>â€¢ {item.ë°œê²¬ë‚´ìš©}</div>
                                                                {renderLawBadges(item.ë²•ì ê·¼ê±°)}
                                                                {item.ê°œì„ ê¶Œê³  && <div style={{ marginTop: '0.8rem', padding: '1rem', background: '#f8fafc', borderRadius: '10px', borderLeft: '4px solid #3b82f6', fontSize: '0.9rem', fontWeight: 600 }}>ğŸ’¡ ê¶Œê³ : {item.ê°œì„ ê¶Œê³ }</div>}
                                                            </td>
                                                        </tr>
                                                    ))}
                                                </tbody>
                                            </table>
                                        </div>

                                        {result.finalRecommendations && (
                                            <div className="recommendations-content">
                                                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '1.5rem' }}>
                                                    <h3 style={{ display: 'flex', alignItems: 'center', gap: '0.5rem', color: '#92400e', fontSize: '1.4rem', fontWeight: 800, margin: 0 }}><Scale size={28} /> ì¢…í•© ë³´ì™„ ê°€ì´ë“œ</h3>

                                                </div>
                                                <div style={{ fontSize: '1.05rem', fontWeight: 600, color: '#92400e', whiteSpace: 'pre-line' }}>{result.finalRecommendations}</div>
                                            </div>
                                        )}



                                        <div style={{ marginTop: '3rem', textAlign: 'center', paddingBottom: '3rem', display: 'flex', gap: '1rem', justifyContent: 'center' }}>
                                            {(result.overallStatus === 'ìœ„í—˜' || result.overallStatus === 'ë¶€ì ì ˆ' || result.overallStatus === 'ë³´ì™„í•„ìš”' || result.overallStatus === 'ì£¼ì˜') && (
                                                <button
                                                    onClick={generateContract}
                                                    disabled={isGenerating}
                                                    style={{ padding: '1rem 3rem', borderRadius: '14px', background: isGenerating ? '#94a3b8' : 'var(--primary)', color: 'white', fontWeight: 800, border: 'none', cursor: isGenerating ? 'not-allowed' : 'pointer', display: 'flex', alignItems: 'center', gap: '0.5rem' }}
                                                >
                                                    <FileText size={24} /> {isGenerating ? 'ê³„ì•½ì„œ ìƒì„± ì¤‘...' : 'ê·¼ë¡œê³„ì•½ì„œ ìƒì„±í•˜ê¸°'}
                                                </button>
                                            )}
                                            <button onClick={() => { setSelectedService(null); setCurrentStep('upload'); setGeneratedContract(null); }} style={{ padding: '1rem 3rem', borderRadius: '14px', background: '#1e293b', color: 'white', fontWeight: 800, border: 'none', cursor: 'pointer' }}>ì²˜ìŒìœ¼ë¡œ</button>
                                        </div>
                                    </div>
                                </div>
                            )
                        }

                        {
                            currentStep === 'contract' && generatedContract && (
                                <motion.div className={currentStep === 'result' ? "analysis-overlay" : "upload-modal-overlay"} initial={{ opacity: 0 }} animate={{ opacity: 1 }}>
                                    <StepIndicator currentStep={currentStep} />

                                    <div className="split-container" style={{ maxWidth: '100%', width: '100%', marginTop: '1rem' }}>
                                        <div className="document-viewer" style={{ flex: 1 }}>
                                            <div style={{ position: 'sticky', top: '2rem', width: '100%' }}>
                                                <h4 style={{ fontWeight: 800, color: '#64748b', marginBottom: '1rem' }}>ì—…ë¡œë“œí•œ ì›ë³¸ ì‚¬ì§„ ({previewUrls.length}ì¥)</h4>
                                                {previewUrls.length > 0 ? (
                                                    <div style={{ display: 'flex', flexDirection: 'column', gap: '1rem' }}>
                                                        {previewUrls.map((url, idx) => (
                                                            <img key={idx} src={url} alt={`Uploaded Contract ${idx + 1}`} className="document-image" style={{ width: '100%', borderRadius: '16px', border: '2px solid #e2e8f0' }} />
                                                        ))}
                                                    </div>
                                                ) : (
                                                    <div style={{ padding: '3rem', background: '#f1f5f9', borderRadius: '16px', textAlign: 'center', color: '#94a3b8' }}>
                                                        <FileText size={48} style={{ margin: '0 auto 1rem' }} />
                                                        <p>ì´ë¯¸ì§€ê°€ ì—…ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤</p>
                                                    </div>
                                                )}
                                            </div>
                                        </div>

                                        <div className="analysis-panel" style={{ flex: 1 }}>
                                            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '1rem' }}>
                                                <h2 style={{ display: 'flex', alignItems: 'center', gap: '0.5rem', fontSize: '1.5rem', fontWeight: 800 }}><Edit3 size={28} color="var(--primary)" /> í‘œì¤€ê·¼ë¡œê³„ì•½ì„œ ì‘ì„±</h2>
                                                <div style={{ display: 'flex', gap: '0.5rem' }}>
                                                    <button
                                                        onClick={() => {
                                                            const printWindow = window.open('', '_blank');
                                                            printWindow.document.write(`
                                                              <html>
                                                                <head>
                                                                  <title>í‘œì¤€ê·¼ë¡œê³„ì•½ì„œ</title>
                                                                  <style>body { font-family: 'Malgun Gothic', sans-serif; padding: 40px; line-height: 1.8; white-space: pre-wrap; }</style>
                                                                </head>
                                                                <body>${generatedContract}</body>
                                                              </html>
                                                            `);
                                                            printWindow.document.close();
                                                            printWindow.print();
                                                        }}
                                                        style={{ display: 'flex', alignItems: 'center', gap: '0.5rem', background: '#ef4444', color: 'white', padding: '0.6rem 1rem', borderRadius: '10px', fontWeight: 700, border: 'none', cursor: 'pointer', fontSize: '0.9rem' }}
                                                    >
                                                        <FileText size={16} /> PDF
                                                    </button>
                                                    <button
                                                        onClick={() => {
                                                            const blob = new Blob(['\ufeff', generatedContract], { type: 'application/msword' });
                                                            const url = URL.createObjectURL(blob);
                                                            const link = document.createElement('a');
                                                            link.href = url;
                                                            link.download = `í‘œì¤€ê·¼ë¡œê³„ì•½ì„œ_${new Date().toISOString().slice(0, 10)}.doc`;
                                                            link.click();
                                                            URL.revokeObjectURL(url);
                                                        }}
                                                        style={{ display: 'flex', alignItems: 'center', gap: '0.5rem', background: '#3b82f6', color: 'white', padding: '0.6rem 1rem', borderRadius: '10px', fontWeight: 700, border: 'none', cursor: 'pointer', fontSize: '0.9rem' }}
                                                    >
                                                        <FileText size={16} /> Word
                                                    </button>
                                                </div>
                                            </div>

                                            <div style={{ background: '#f8fafc', padding: '1.5rem', borderRadius: '16px', border: '2px solid #3b82f6' }}>
                                                <textarea
                                                    value={generatedContract}
                                                    onChange={(e) => setGeneratedContract(e.target.value)}
                                                    style={{ width: '100%', height: '600px', padding: '1.5rem', borderRadius: '12px', border: '1px solid #cbd5e1', fontSize: '1rem', lineHeight: '1.8', outline: 'none', fontFamily: "'Malgun Gothic', sans-serif'", whiteSpace: 'pre-wrap' }}
                                                    placeholder="ê³„ì•½ì„œ ë‚´ìš©ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤..."
                                                />
                                            </div>

                                            <div style={{ marginTop: '2rem', display: 'flex', gap: '1rem', justifyContent: 'center' }}>
                                                <button onClick={() => setCurrentStep('result')} style={{ padding: '1rem 3rem', borderRadius: '14px', background: 'white', border: '1px solid #cbd5e1', color: '#64748b', fontWeight: 700, cursor: 'pointer' }}>ì´ì „ ë‹¨ê³„</button>
                                                <button onClick={() => window.location.reload()} style={{ padding: '1rem 3rem', borderRadius: '14px', background: '#1e293b', color: 'white', fontWeight: 800, border: 'none', cursor: 'pointer' }}>ì²˜ìŒìœ¼ë¡œ</button>
                                            </div>
                                        </div>
                                    </div>
                                </motion.div>
                            )
                        }
                    </motion.div >
                )}
            </AnimatePresence >
        </div >
    );
};

export default App;
